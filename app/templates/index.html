<!-- app/templates/index.html -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Chaveiro Brotero - Cupom</title>
  <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}?v=2.0">
</head>
<body>
  <div class="container">
    <header class="header">
      <div style="display: flex; align-items: center;">
        <div class="logo">üîë</div>
        <div class="title">CHAVEIRO BROTERO</div>
      </div>
      <button id="theme-toggle" class="btn btn-theme" onclick="toggleTheme()" title="Alternar tema">
        <span id="theme-icon">üåô</span>
      </button>
    </header>

    {% if error %}
      <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    {% if msg %}
      <div class="alert alert-success">
        <div>{{ msg }}</div>
        {% if nfse_pdf_id %}
        <div style="margin-top: 12px;">
          <a href="/api/nfse/download/{{ nfse_pdf_id }}" class="btn primary" target="_blank" style="text-decoration: none;">
            üìÑ Baixar DANFSE (PDF)
          </a>
        </div>
        {% endif %}
      </div>
    {% endif %}

    <section class="form-section">
      <h2>Itens do Cupom</h2>
      <form id="cupom-form" method="post">
        <table class="items-table">
          <thead>
            <tr>
              <th>Descri√ß√£o</th>
              <th>Qtd</th>
              <th>Valor (R$)</th>
              <th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody id="items-body">
            {% if itens and itens|length > 0 %}
              {% for desc, qtd, val in itens %}
              <tr>
                <td><input type="text" name="descricao" value="{{ desc }}" required></td>
                <td><input type="number" name="quantidade" value="{{ qtd }}" min="1" required></td>
                <td><input type="text" name="valor" value="{{ val }}" required></td>
                <td>  
                  <button type="button" class="btn danger" onclick="removeRow(this)">üóëÔ∏è</button>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td><input type="text" name="descricao" placeholder="Ex: C√≥pia de chave tetra" required></td>
                <td><input type="number" name="quantidade" value="1" min="1" required></td>
                <td><input type="text" name="valor" placeholder="25,00" required></td>
                <td>  
                  <button type="button" class="btn danger" onclick="removeRow(this)">üóëÔ∏è</button>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>

        <button type="button" class="btn secondary" onclick="addItemRow()">‚ûï Adicionar item</button>

        <div class="total-row">
          <span>Total aproximado:</span>
          <strong id="total-value">R$ 0,00</strong>
        </div>

        <div class="options">
          <label>
            <input type="checkbox" name="samaritano" id="samaritano-checkbox"
                   {% if samaritano %}checked{% endif %}>
            Servi√ßo para o Samaritano
          </label>

          <div id="os-field" class="{% if not samaritano %}hidden{% endif %}">
            <label>N√∫mero da OS:
              <input type="text" name="numero_os" value="{{ numero_os or '' }}">
            </label>
          </div>

          <label>
            <input type="checkbox" name="emitir_nfse" id="nfse-checkbox"
                   {% if emitir_nfse %}checked{% endif %}>
            Emitir Nota Fiscal (NFSe)
          </label>

          <div id="nfse-field" class="{% if not emitir_nfse %}hidden{% endif %}">
            <label>CPF/CNPJ do Tomador:
              <input type="text" name="cpf_cnpj" id="cpf-cnpj-input" 
                     value="{{ cpf_cnpj or '' }}" 
                     placeholder="000.000.000-00 ou 00.000.000/0000-00"
                     maxlength="18"
                     {% if emitir_nfse %}required{% endif %}>
            </label>
          </div>
        </div>

        <div class="actions">
          <button formaction="/preview" formmethod="post" class="btn">Pr√©-visualizar</button>
          <button formaction="/emitir" formmethod="post" class="btn primary">Emitir cupom</button>
        </div>
      </form>
    </section>

    <section class="preview-section">
      <h2>Pr√©-visualiza√ß√£o</h2>
      {% if preview_text %}
        <pre class="preview-box">{{ preview_text }}</pre>
      {% else %}
        <div class="preview-placeholder">Nenhum cupom pr√©-visualizado ainda.</div>
      {% endif %}
    </section>

    <section class="history-section">
      <div class="history-section-header">
        <h2>Hist√≥rico de Emiss√µes</h2>
        <a href="/relatorios" class="btn btn-reports">üìä Relat√≥rios</a>
      </div>
      {% if historico and historico|length > 0 %}
        <div class="history-grid">
          {% for cupom in historico %}
          <div class="history-card {% if (cupom.status or 'ATIVO') == 'CANCELADO' %}history-card-canceled{% endif %}" data-cupom-id="{{ cupom.id }}">
            <div class="history-card-header">
              <div class="history-card-date">
                <span class="date-icon">üìÖ</span>
                <span>{{ cupom.data_emissao_formatada }}</span>
              </div>
              <span class="history-status-badge {% if (cupom.status or 'ATIVO') == 'ATIVO' %}status-ativo{% else %}status-cancelado{% endif %}">
                {% if (cupom.status or 'ATIVO') == 'ATIVO' %}ATIVO{% else %}CANCELADO{% endif %}
              </span>
            </div>
            
            <div class="history-card-body">
              <div class="history-card-type">
                <span class="type-badge {% if cupom.samaritano %}samaritano{% else %}padrao{% endif %}">
                  {% if cupom.samaritano %}ü©∫ Samaritano{% else %}üìÑ Padr√£o{% endif %}
                </span>
                {% if cupom.numero_os %}
                <span class="os-badge">OS: {{ cupom.numero_os }}</span>
                {% endif %}
              </div>
              
              <div class="history-card-items">
                {% for item in cupom.itens %}
                <div class="history-item-line">
                  <span class="item-quantity">{{ item.quantidade }}x</span>
                  <span class="item-desc">{{ item.descricao }}</span>
                  <span class="item-value">R$ {{ item.valor_unitario_formatado }}</span>
                </div>
                {% endfor %}
              </div>
              
              <div class="history-card-total">
                <span>Total:</span>
                <strong>R$ {{ cupom.total_formatado }}</strong>
              </div>
            </div>
            
            {% if (cupom.status or 'ATIVO') == 'ATIVO' %}
            <div class="history-card-footer">
              <button type="button" class="btn btn-small danger" onclick="cancelarCupom('{{ cupom.id }}', event)">Cancelar</button>
              <button type="button" class="btn btn-small secondary" onclick="verDetalhes('{{ cupom.id }}')">Ver Detalhes</button>
            </div>
            {% else %}
            <div class="history-card-footer">
              <span class="canceled-label">Cupom cancelado</span>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="preview-placeholder">Nenhum cupom emitido ainda.</div>
      {% endif %}
    </section>

    <!-- Modal de Detalhes -->
    <div id="modal-detalhes" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Detalhes do Cupom</h2>
          <button class="btn danger" onclick="fecharModalDetalhes()" style="padding: 4px 8px;">‚úï</button>
        </div>
        <div id="modal-detalhes-content" class="modal-body"></div>
      </div>
    </div>
  </div>

  <script>
    function addItemRow() {
      const tbody = document.getElementById('items-body');
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><input type="text" name="descricao" placeholder="Descri√ß√£o" required></td>
        <td><input type="number" name="quantidade" value="1" min="1" required></td>
        <td><input type="text" name="valor" placeholder="0,00" required></td>
        <td>  
          <button type="button" class="btn danger" onclick="removeRow(this)">üóëÔ∏è</button>
        </td>
      `;
      tbody.appendChild(tr);
    }

    function removeRow(button) {
      const row = button.closest('tr');
      row.remove()
    }
      function parseBrazilianMoney(str) {
    if (!str) return 0;
    str = str.replace("R$", "").replace(/\s/g, "").replace(".", "").replace(",", ".");
    const val = parseFloat(str);
    return isNaN(val) ? 0 : val;
  }

  function recalcTotal() {
    const tbody = document.getElementById('items-body');
    const rows = tbody.querySelectorAll('tr');
    let total = 0;

    rows.forEach(row => {
      const qtdInput = row.querySelector('input[name="quantidade"]');
      const valInput = row.querySelector('input[name="valor"]');

      const qtd = parseInt(qtdInput.value || "0", 10);
      const val = parseBrazilianMoney(valInput.value || "0");

      if (qtd > 0 && val > 0) {
        total += qtd * val;
      }
    });

    // Formatar em R$ xx,xx estilo brasileiro
    const inteiro = Math.floor(total);
    const centavos = Math.round((total - inteiro) * 100);
    const inteiroStr = inteiro.toLocaleString("pt-BR");
    const centavosStr = centavos.toString().padStart(2, "0");

    const totalSpan = document.getElementById('total-value');
    totalSpan.textContent = `R$ ${inteiroStr},${centavosStr}`;
  }

  function attachInputListeners(rowOrDocument) {
    const scope = rowOrDocument || document;
    const qtdInputs = scope.querySelectorAll('input[name="quantidade"]');
    const valInputs = scope.querySelectorAll('input[name="valor"]');

    qtdInputs.forEach(inp => {
      inp.removeEventListener('input', recalcTotal);
      inp.addEventListener('input', recalcTotal);
    });
    valInputs.forEach(inp => {
      inp.removeEventListener('input', recalcTotal);
      inp.addEventListener('input', recalcTotal);
    });
    }

    const samaritanoCheckbox = document.getElementById('samaritano-checkbox');
    const osField = document.getElementById('os-field');
    const nfseCheckbox = document.getElementById('nfse-checkbox');
    const nfseField = document.getElementById('nfse-field');
    const cpfCnpjInput = document.getElementById('cpf-cnpj-input');

    function toggleOSField() {
      if (samaritanoCheckbox.checked) {
        osField.classList.remove('hidden');
      } else {
        osField.classList.add('hidden');
      }
    }

    function toggleNFSeField() {
      if (nfseCheckbox.checked) {
        nfseField.classList.remove('hidden');
        cpfCnpjInput.focus();
      } else {
        nfseField.classList.add('hidden');
      }
    }

    // M√°scara para CPF/CNPJ
    function aplicarMascaraCPFCNPJ(input) {
      let value = input.value.replace(/\D/g, '');
      
      if (value.length <= 11) {
        // CPF: 000.000.000-00
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      } else {
        // CNPJ: 00.000.000/0000-00
        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
      }
      
      input.value = value;
    }

    samaritanoCheckbox.addEventListener('change', toggleOSField);
    nfseCheckbox.addEventListener('change', toggleNFSeField);
    cpfCnpjInput.addEventListener('input', function() {
      aplicarMascaraCPFCNPJ(this);
    });
    
    toggleOSField();
    toggleNFSeField();

    document.addEventListener('DOMContentLoaded', function(){
      attachInputListeners(document);
      recalcTotal();
    });


    async function cancelarCupom(cupomId, event) {
      event.preventDefault();
      event.stopPropagation();
      
      if (!confirm('Tem certeza que deseja cancelar este cupom?')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/cupom/${cupomId}/cancelar`, {
          method: 'POST',
        });
        const data = await response.json();
        
        if (data.success) {
          // Atualiza a UI dinamicamente sem recarregar a p√°gina
          atualizarCardCupom(cupomId);
        } else {
          alert('Erro ao cancelar cupom: ' + data.message);
        }
      } catch (error) {
        alert('Erro ao cancelar cupom: ' + error.message);
      }
    }

    async function atualizarCardCupom(cupomId) {
      try {
        // Busca o hist√≥rico atualizado
        const response = await fetch(`/api/historico?limit=10`);
        const historico = await response.json();
        
        // Encontra o cupom atualizado
        const cupom = historico.find(c => c.id === cupomId);
        if (!cupom) {
          // Se n√£o encontrou, recarrega a p√°gina
          location.reload();
          return;
        }
        
        // Encontra o card do cupom usando data-cupom-id
        const card = document.querySelector(`.history-card[data-cupom-id="${cupomId}"]`);
        if (!card) {
          // Se n√£o encontrou o card, recarrega a p√°gina
          location.reload();
          return;
        }
        
        // Atualiza o badge de status
        const cardHeader = card.querySelector('.history-card-header');
        const statusBadge = cardHeader?.querySelector('.history-status-badge');
        if (statusBadge) {
          statusBadge.className = 'history-status-badge status-cancelado';
          statusBadge.textContent = 'CANCELADO';
        }
        
        // Adiciona classe de cancelado ao card
        card.classList.add('history-card-canceled');
        
        // Atualiza o footer
        const cardFooter = card.querySelector('.history-card-footer');
        if (cardFooter) {
          cardFooter.innerHTML = '<span class="canceled-label">Cupom cancelado</span>';
        }
        
        // Mostra mensagem de sucesso
        alert('Cupom cancelado com sucesso!');
      } catch (error) {
        console.error('Erro ao atualizar card:', error);
        // Em caso de erro, recarrega a p√°gina
        location.reload();
      }
    }

    function formatMoney(value) {
      const num = parseFloat(value);
      const inteiro = Math.floor(num);
      const centavos = Math.round((num - inteiro) * 100);
      const inteiroStr = inteiro.toLocaleString('pt-BR');
      return `${inteiroStr},${centavos.toString().padStart(2, '0')}`;
    }

    async function verDetalhes(cupomId) {
      try {
        const response = await fetch(`/api/historico`);
        const historico = await response.json();
        const cupom = historico.find(c => c.id === cupomId);
        
        if (!cupom) {
          alert('Cupom n√£o encontrado');
          return;
        }
        
        const modal = document.getElementById('modal-detalhes');
        const content = document.getElementById('modal-detalhes-content');
        
        let html = `
          <div class="detalhes-cupom">
            <div class="detalhes-header">
              <p><strong>Data:</strong> ${cupom.data_emissao_formatada || cupom.data_emissao}</p>
              <p><strong>Status:</strong> <span class="status-badge ${(cupom.status || 'ATIVO') === 'ATIVO' ? 'status-ativo' : 'status-cancelado'}">${cupom.status || 'ATIVO'}</span></p>
              <p><strong>Tipo:</strong> ${cupom.samaritano ? 'ü©∫ Samaritano' : 'üìÑ Padr√£o'}</p>
              ${cupom.numero_os ? `<p><strong>OS:</strong> ${cupom.numero_os}</p>` : ''}
            </div>
            <div class="detalhes-itens">
              <h4>Itens:</h4>
              <ul>
        `;
        
        cupom.itens.forEach(item => {
          const valorFormatado = item.valor_unitario_formatado || formatMoney(item.valor_unitario);
          html += `<li>${item.quantidade}x ${item.descricao} - R$ ${valorFormatado}</li>`;
        });
        
        const totalFormatado = cupom.total_formatado || formatMoney(cupom.total);
        
        html += `
              </ul>
            </div>
            <div class="detalhes-total">
              <p><strong>Total: R$ ${totalFormatado}</strong></p>
            </div>
            <div class="detalhes-texto">
              <h4>Texto do Cupom:</h4>
              <pre class="preview-box">${cupom.texto_cupom}</pre>
            </div>
          </div>
        `;
        
        content.innerHTML = html;
        modal.style.display = 'flex';
      } catch (error) {
        alert('Erro ao carregar detalhes: ' + error.message);
      }
    }

    function fecharModalDetalhes() {
      document.getElementById('modal-detalhes').style.display = 'none';
    }

    // Fechar modal ao clicar fora
    window.onclick = function(event) {
      const modalDetalhes = document.getElementById('modal-detalhes');
      if (event.target === modalDetalhes) {
        fecharModalDetalhes();
      }
    }

    // Toggle de Tema
    function toggleTheme() {
      const body = document.body;
      const themeIcon = document.getElementById('theme-icon');
      const isDark = body.classList.toggle('dark-mode');
      
      // Salva prefer√™ncia no localStorage
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Atualiza √≠cone
      themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    // Carrega tema salvo ao carregar p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme');
      const body = document.body;
      const themeIcon = document.getElementById('theme-icon');
      
      if (savedTheme === 'dark') {
        body.classList.add('dark-mode');
        themeIcon.textContent = '‚òÄÔ∏è';
      } else {
        body.classList.remove('dark-mode');
        themeIcon.textContent = 'üåô';
      }
    });
  </script>
</body>
</html>
